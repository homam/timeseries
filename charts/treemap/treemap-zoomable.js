// Generated by CoffeeScript 1.6.2
(function() {
  var exports;

  exports = exports != null ? exports : this;

  exports.treeMapZoomableChart = function() {
    var aheight, awidth, chart, color, formatConv, formatNumber, height, margin, rectHeight, rectWidth, treemap, width, x, y;

    margin = {
      top: 0,
      right: 0,
      bottom: 0,
      left: 0
    };
    width = 1200;
    height = 900;
    awidth = width - margin.left - margin.right;
    aheight = height - margin.top - margin.bottom;
    formatConv = d3.format('.2%');
    formatNumber = d3.format(',');
    x = d3.scale.linear().range([0, awidth]);
    y = d3.scale.linear().range([0, aheight]);
    color = d3.scale.category20();
    treemap = d3.layout.treemap().size([width - margin.left - margin.right, height - margin.left - margin.right]).round(false).sticky(true).value(function(d) {
      return d.visits;
    });
    rectWidth = function(d) {
      if (d.dx > 2) {
        return d.dx - 2;
      } else {
        return 0;
      }
    };
    rectHeight = function(d) {
      if (d.dy > 2) {
        return d.dy - 2;
      } else {
        return 0;
      }
    };
    chart = function(selection) {
      return selection.each(function() {
        var $svg, currentNode, zoom;

        $svg = d3.select(this).append('svg').attr('class', 'chart').attr("width", width).attr("height", height).append("g").attr('transform', 'translate(' + margin.top + ',' + margin.left + ')');
        currentNode = null;
        zoom = function(r, single) {
          var kx, ky, t;

          if (single == null) {
            single = false;
          }
          kx = awidth / r.dx;
          ky = aheight / r.dy;
          x.domain([r.x, r.dx + r.x]);
          y.domain([r.y, r.dy + r.y]);
          t = $svg.selectAll('.node').transition().duration(1500).attr('transform', function(d) {
            return "translate(" + x(d.x) + "," + y(d.y) + ")";
          });
          t.select('rect').attr('width', function(d) {
            return kx * d.dx;
          }).attr('height', function(d) {
            return ky * d.dy;
          });
          t.select('text').attr('x', function(d) {
            return kx * d.dx / 2;
          }).attr('y', function(d) {
            return ky * d.dy / 2;
          }).style('opacity', function(d) {
            if (kx * d.dx > d._tw) {
              return 1;
            } else {
              return 0;
            }
          });
          currentNode = r;
          return d3.event.stopPropagation();
        };
        window.zoom = zoom;
        return chart.draw = function(root) {
          var $node, nodes;

          nodes = treemap.nodes(root).filter(function(d) {
            return d.children.length === 0;
          });
          currentNode = root;
          $node = $svg.selectAll('.node').data(nodes).enter().append('g').attr('class', 'node').on('dblclick', function(d) {
            if (!d.parent || currentNode.wurfl_device_id === d.parent.wurfl_device_id) {
              return zoom(root);
            } else {
              return zoom(d.parent);
            }
          }).on('click', function(d) {
            console.log(currentNode.wurfl_device_id, d.parent ? d.parent.wurfl_device_id : '');
            if (!d.parent || currentNode.wurfl_device_id === d.parent.wurfl_device_id) {
              return zoom(d, true);
            } else {
              return zoom(d.parent);
            }
          });
          $node.attr('transform', function(d) {
            return "translate(" + d.x + "," + d.y + ")";
          });
          $node.append('rect').attr('width', rectWidth).attr('height', rectHeight).style('fill', function(d) {
            return color(d.wurfl_device_id);
          }).attr('stroke', 'white');
          return $node.append('text').attr('x', function(d) {
            return d.dx / 2;
          }).attr('y', function(d) {
            return d.dy / 2;
          }).attr('dy', '.35em').attr('text-anchor', 'middle').text(function(d) {
            if (d.children.length > 0) {
              return null;
            }
            return d.brand_name + ' ' + d.model_name;
          }).style('opacity', function(d) {
            d._tw = this.getComputedTextLength();
            if (d.dx > d._tw) {
              return 1;
            } else {
              return 0;
            }
          });
        };
      });
    };
    return chart;
  };

}).call(this);
