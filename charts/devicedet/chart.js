// Generated by CoffeeScript 1.6.2
(function() {
  var addBack, chart, collectLongTail, data, even, f, fp, g, gp, groupBy, groupByBrandName, h, hp, isPrime, makeTreeByParentId, pack;

  isPrime = function(x) {
    return [2, 3, 5, 7].indexOf(x) > -1;
  };

  even = function(x) {
    return x % 2 === 0;
  };

  h = function(map, xs) {
    return map(xs.filter(function(x) {
      return x <= 5;
    }));
  };

  g = function(map, xs) {
    return _.chain(xs).groupBy(isPrime).map(function(arr) {
      return map(arr);
    }).value();
  };

  f = function(map, xs) {
    return _.chain(xs).groupBy(even).map(function(arr) {
      return map(arr);
    }).value();
  };

  data = _.range(1, 11);

  hp = _.partial(h, _.identity);

  gp = _.partial(g, hp);

  fp = _.partial(f, gp);

  console.log(fp(data));

  pack = function(root, data) {
    data.forEach(function(d, i) {
      if (d !== null && d.wurfl_fall_back === root.wurfl_device_id) {
        data = pack(d, data);
        root.children.push(d);
        return data[i] = null;
      }
    });
    return data;
  };

  makeTreeByParentId = function(data) {
    var _i, _j, _ref, _ref1, _results, _results1;

    (function() {
      _results = [];
      for (var _i = 0, _ref = data.length - 1; 0 <= _ref ? _i <= _ref : _i >= _ref; 0 <= _ref ? _i++ : _i--){ _results.push(_i); }
      return _results;
    }).apply(this).forEach(function(i) {
      var d;

      d = data[i];
      if (!!d) {
        data = pack(data[i], data);
      }
      return data = data.filter(function(d) {
        return d !== null;
      });
    });
    (function() {
      _results1 = [];
      for (var _j = 0, _ref1 = data.length - 1; 0 <= _ref1 ? _j <= _ref1 : _j >= _ref1; 0 <= _ref1 ? _j++ : _j--){ _results1.push(_j); }
      return _results1;
    }).apply(this).forEach(function(i) {
      return addBack(data[i]);
    });
    return data;
  };

  addBack = function(root) {
    if (root.children.length > 0) {
      root.children.forEach(addBack);
      return root.children.push({
        children: [],
        wurfl_device_id: root.wurfl_device_id,
        wurfl_fall_back: root.wurfl_fall_back,
        brand_name: root.brand_name,
        model_name: root.model_name,
        conv: root.conv,
        device_os: root.device_os,
        visits: root.visits,
        subscribers: root.subscribers
      });
    }
  };

  groupBy = function(childrenMap, what, data) {
    var groups;

    groups = _(data).groupBy(what);
    return _(groups).map(function(darr) {
      var groupAverageConv, groupStdevConversion, groupSubs, groupVisits;

      groupVisits = darr.map(function(d) {
        return d.visits;
      }).reduce(function(a, b) {
        return a + b;
      });
      groupSubs = darr.map(function(d) {
        return d.subscribers;
      }).reduce(function(a, b) {
        return a + b;
      });
      groupAverageConv = groupSubs / groupVisits;
      groupStdevConversion = darr.map(function(g) {
        return Math.sqrt(Math.pow(g.conv - groupAverageConv, 2)) * g.visits / groupVisits;
      }).reduce(function(a, b) {
        return a + b;
      });
      return {
        averageConversion: groupAverageConv,
        stdevConversion: groupStdevConversion,
        children: childrenMap(darr)
      };
    });
  };

  collectLongTail = function(data) {
    var more, moreSubs, moreVisits;

    if (data.length < 2) {
      return data;
    }
    more = data.filter(function(d) {
      return d.visits <= 100;
    });
    if (more.length < 2) {
      return data;
    }
    moreVisits = more.map(function(d) {
      return d.visits;
    }).reduce(function(a, b) {
      return a + b;
    });
    moreSubs = more.map(function(d) {
      return d.subscribers;
    }).reduce(function(a, b) {
      return a + b;
    });
    data = data.filter(function(d) {
      return d.visits > 100;
    });
    data.push({
      children: [],
      wurfl_fall_back: 'root',
      wurfl_device_id: 'more...',
      brand_name: 'more',
      model_name: '..',
      device_os: 'any',
      visits: moreVisits,
      subscribers: moreSubs,
      conv: moreSubs / moreVisits
    });
    return data;
  };

  groupByBrandName = function(data) {
    var brandF, osF;

    osF = _.partial(groupBy, _.compose(makeTreeByParentId, collectLongTail), function(d) {
      return d.device_os;
    });
    brandF = _.partial(groupBy, osF, function(d) {
      return d.brand_name;
    });
    return brandF(data);
  };

  chart = treeMapZoomableChart();

  d3.select('#chart').call(chart);

  d3.csv('charts/devicedet/data/ae.csv', function(raw) {
    var draw, fresh, makeGroupByFunction, redraw, subMethods;

    fresh = function() {
      return raw.map(function(d) {
        return {
          wurfl_device_id: d.wurfl_device_id,
          wurfl_fall_back: d.wurfl_fall_back,
          brand_name: d.brand_name,
          model_name: d.model_name,
          visits: +d.visits,
          subscribers: +d.subscribers,
          method: d.method,
          conv: (+d.conv) || 0,
          device_os: d.device_os,
          children: []
        };
      });
    };
    draw = function(method, chartDataMap) {
      var chartData, totalConv, totalStdevConv, totalSubs, totalVisits, tree;

      chartData = fresh().filter((function(d) {
        return method === d.method;
      }));
      totalVisits = chartData.map(function(d) {
        return d.visits;
      }).reduce(function(a, b) {
        return a + b;
      });
      totalSubs = chartData.map(function(d) {
        return d.subscribers;
      }).reduce(function(a, b) {
        return a + b;
      });
      totalConv = totalSubs / totalVisits;
      totalStdevConv = chartData.map(function(g) {
        return Math.sqrt(Math.pow(g.conv - totalConv, 2)) * g.visits / totalVisits;
      }).reduce(function(a, b) {
        return a + b;
      });
      chartData = chartDataMap(chartData);
      window.chartData = chartData;
      tree = {
        children: chartData,
        wurfl_device_id: 'root',
        brand_name: 'root',
        model_name: 'root',
        averageConversion: totalConv,
        stdevConversion: totalStdevConv,
        visits: 0
      };
      return chart.draw(tree);
    };
    subMethods = _.chain(fresh()).map(function(d) {
      return d.method;
    }).uniq().value();
    d3.select('#submethods').data([subMethods]).on('change', function() {
      return redraw();
    }).selectAll('option').data(function(d) {
      return d;
    }).enter().append('option').text(function(d) {
      return d;
    });
    makeGroupByFunction = function(order, treefy, cutLongTail) {
      var l, lastF, t;

      order = _(order).reverse();
      t = treefy ? makeTreeByParentId : _.identity;
      l = cutLongTail ? collectLongTail : _.identity;
      lastF = _.compose(t, l);
      order.forEach(function(p) {
        return lastF = _.partial(groupBy, lastF, function(d) {
          return d[p];
        });
      });
      return lastF;
    };
    redraw = function() {
      var groupBys;

      groupBys = ($('#groupbys-bin').find('li').map(function() {
        return $(this).attr('data-groupby');
      })).get();
      return draw($("#submethods").val(), makeGroupByFunction(groupBys, $('#treefy')[0].checked, true));
    };
    redraw();
    return $(function() {
      $('#groupbys-bin, #groupbys').sortable({
        connectWith: '.connected'
      });
      $('#groupbys-bin, #groupbys').on('dragend', function() {
        return redraw();
      });
      return $('#treefy').on('change', function() {
        return redraw();
      });
    });
  });

}).call(this);
